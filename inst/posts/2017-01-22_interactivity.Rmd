---
title: "Interactivity in R Geospatial Workflows"
author: "Tim Appelhans and Kenton Russell"
date: "January 27, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The R ecosystem offers a powerful set of packages for geospatial analysis.  However, many geospatial workflows require interactivity for smooth uninterrupted completion.  With new tools, such as htmlwidgets, shiny, and crosstalk, we can now inject this useful interactivity without leaving the R environment.  In the first phase of the project, we have focused on experimenting and creating proof of concepts for the following three objectives:

1. drawing, editing, and deleting features,

2. selecting and querying of features and map regions,

3. editing attributes.

## Install mapedit

To run the code in the following discussion, please install with `devtools::install_github`.  Please be aware that the current functionality is strictly a proof of concept, and the API will change rapidly and dramatically.

```
devtools::install_github("r-spatial/mapedit")
```

## Drawing, Editing, Deleting Features

We would like to set up an easy process for CRUD (create, read, update, and delete) of map features.  The function `edit_map` demonstrates a first step toward this goal.

### Proof of Concept 1 | Draw on Blank Map

To see how we might add some features, let's start with a blank map, and then feel free to draw, edit, and delete with the `Leaflet.Draw` toolbar on the map.

```
library(leaflet)
library(mapedit)

what_we_created <- leaflet() %>%
  addTiles() %>%
  edit_map()
```

`edit_map` returns a `list` with drawn, edited, deleted, and finished features as [`GeoJSON`](https://tools.ietf.org/html/rfc7946).  In this case, if we would like to see our finished creation we can focus on `what_we_created$finished`.  Since this is `GeoJSON`, the easiest way to see what we just created will be to use the `addGeoJSON` function from `leaflet`.  This works well with polylines, polygons, rectangles, and points, but circles will be treated as points without some additional code.

```
leaflet() %>%
  addTiles() %>%
  addGeoJSON(what_we_created$finished)
```

### Proof of Concept 2 | Edit and Delete Existing Features

As an extension of the first proof of concept, we might like to edit and/or delete existing features.  Let's play Donald Trump for this exercise and use the border between Mexico and the United States for California and Arizona.  For the sake of the example, let's use a simplified polyline as our border.  As we have promised we want to build a wall, but if we could just move the border a little in some places, we might be able to ease construction.

```
library(sf)

# simplified border for purpose of exercise
border <- st_as_sfc(
"LINESTRING(-109.050197582692 31.3535554844322, -109.050197582692 31.3535554844322, -111.071681957692 31.3723176640684, -111.071681957692 31.3723176640684, -114.807033520192 32.509681296831, -114.807033520192 32.509681296831, -114.741115551442 32.750242384668, -114.741115551442 32.750242384668, -117.158107738942 32.5652527715121, -117.158107738942 32.5652527715121)"
) %>%
  st_set_crs(4326)

# plot quickly for visual inspection
plot(border)
```

Since we are Trump, we can do what we want, so let's edit the line to our liking.  We will use `mapview` for our interactive map since it by default gives us an OpenTopoMap layer and the `develop` branch includes simple features support.  With our new border and fence, we will avoid the difficult mountains and get a little extra beachfront.

```
# use develop branch of mapview with simple features support
# devtools::install_github("environmentalinformatics-marburg/mapview@develop")
library(mapview)

new_borders <- mapview(border)@map %>%
  edit_map("border")
```

Now, we can quickly inspect our new borders and then send the coordinates to the wall construction company.

```
leaflet() %>%
  addTiles() %>%
  addGeoJSON(new_borders$drawn)
```

## Selecting Regions

## Editing Attributes
